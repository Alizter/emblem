#!/usr/bin/automake

# Required by libtoolize
ACLOCAL_AMFLAGS = -I m4

# # Use a library
# lib_LTLIBRARIES = libspkg.la
# libspkg_la_SOURCES = src/spkg/spkg.c src/spkg/spkg.h

M4 = m4 -P
M4FLAGS = -E

BUILT_SOURCES = <BUILT_SRCS>

# Binary and sources
bin_PROGRAMS = em
# BUILT_SOURCES = y.tab.h
em_SOURCES = <SRC_FILES>
em_CFLAGS = -Wall -Wextra -Wpedantic -Werror -pedantic-errors -std=gnu2x <DEPS_CFLAGS>
em_LDADD = -lm <DEPS_LIBS>
em_LFLAGS = --bison-bridge --bison-locations -sL -R
em_YFLAGS = -Wall -Wcounterexamples -Wdangling-alias -Wno-yacc -Werror -LC --locations -l -d

src/argp.h: src/argp.c
src/argp.h src/argp.c: em.yml ./scripts/arggen
	./scripts/arggen -xc ./src/argp < $<

./src/pp/ignore_warning.h: ./src/pp/ignore_warning.h.m4
	$(M4) $(M4FLAGS) $< > $@

em.yml:;

# Add documentation
dist_doc_DATA = README.md LICENSE ChangeLog em.1.gz

ChangeLog: ./scripts/changelog.sh
	. $< > $@

./em.1.gz: ./em.yml ./scripts/mangen
	(./scripts/mangen | gzip - -) < $< > $@

# Add tests
TESTS = check_em
check_PROGRAMS = check_em
check_em_SOURCES = <TEST_FILES>
check_em_CFLAGS = -Wall -Wextra -Wpedantic -Werror -pedantic-errors -std=gnu18 <CHECK_DEPS_CFLAGS>
check_em_LDADD = $(em_LDADD) <CHECK_DEPS_LIBS>

y.tab.h: src/em-bibtex_parser.o

doc: docs/html/index.html
.PHONY: doc

doc-coverage: scripts/doxcov docs/html/index.html
	./scripts/doxcov
.PHONY: doc-coverage

docs/html/index.html: scripts/docgen $(em_SOURCES)
	./scripts/docgen

./scripts/arggen ./scripts/changelog.sh ./scripts/mangen ./scripts/docgen:;

EXTRA_DIST = ./scripts/arggen ./scripts/changelog.sh ./scripts/mangen ./em.yml
CLEANFILES = *.log *.swp src/argp.c src/argp.h src/pp/ignore_warning.h ChangeLog em.1.gz y.tab.h docs/html/ docs/man/ docs/rst/ docs/xml/ docs/_static/css/style.css *.bak GPATH GRTAGS GTAGS d_tags
